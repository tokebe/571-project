---
title: "Journalist Visualizations"
author: "Jackson Callaghan"
date: "3/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library import, include=False}
suppressMessages(library(tidyverse))
suppressMessages(library(fiftystater))
suppressMessages(library(viridis))
suppressMessages(library(scales))
suppressMessages(library(sf))
suppressMessages(library(albersusa))
suppressMessages(library(maptools))
suppressMessages(library(sp))
library(usmap)
```


```{r message=FALSE, warning=FALSE}
ufo_us <- read_csv('../Data/ufo_data_us_cleaned_v2.csv') %>% 
  mutate(Posted = as.Date(Posted, format = "%m/%d/%y")) %>% 
  mutate(`Date/Time` = as.Date(`Date/Time`, format = "%m/%d/%y %H:%M")) %>% 
  mutate(State = tolower(state.name[match(State, state.abb)])) %>% 
  filter(`Date/Time` < as.Date('2021-03-24'))

ufo_non_us <- read_csv('../Data/ufo_data_non_us_cleaned_v2.csv') %>% 
  mutate(Posted = as.Date(Posted, format = "%m/%d/%y")) %>% 
  mutate(`Date/Time` = as.Date(`Date.Time`, format = "%m/%d/%y %H:%M")) %>% 
  mutate(State = tolower(state.name[match(State, state.abb)])) %>% 
  filter(`Date/Time` < as.Date('2021-03-24'))

routes_data <- read_csv('../Data/routes.csv')
airport_data <- read.csv('../Data/airports.csv', stringsAsFactors = FALSE)
```

```{r}
data("fifty_states")

year.range <- c(2000, 2021)

ufo_us_freq <- ufo_us %>% 
  filter(
    parse_integer(format(`Date/Time`, "%Y")) > year.range[1] &
    parse_integer(format(`Date/Time`, "%Y")) < year.range[2]
  ) %>% 
  group_by(State) %>% 
  summarise(freq = n()) %>% 
  drop_na()

bg.color <- 'white'

test <- ufo_us_freq %>% 
  ggplot(aes(map_id = State)) +
    geom_map(aes(fill = freq), map = fifty_states, color = bg.color) +
    expand_limits(x = fifty_states$long, y = fifty_states$lat) +
    scale_fill_viridis(limits = c(0, max(ufo_us_freq$freq, na.rm = TRUE))) +
    coord_map(projection = "albers", lat0=39, lat1=45) +
    labs(title = paste(
      "Frequency of UFO sightings, ",
      format(year.range[1]),
      "-", format(year.range[2])
    )) +
    theme_void() +
    theme(plot.background = element_rect(fill = bg.color, color = bg.color))
```

```{r}
ufo_us_coords <- ufo_us %>% 
  dplyr::select(lng, lat, 0:7) %>% 
  usmap_transform() %>% 
  dplyr::select(-lng, -lat) %>% 
  rename(lng = lng.1, lat = lat.1)
```

Need a good sense of what the upper bound should be...

```{r}
qt <- quantile(ufo_us$Duration, na.rm = TRUE, probs = c(.5, .75, .8, .9, 1))

print(qt)

ufo_us %>% 
  filter(Duration < mean(c(qt[[1]], qt[[2]]))) %>% 
ggplot() +
  geom_density(aes(x = Duration))
```


```{r}
# cutoff <- mean(c(qt[[1]], qt[[2]]))
cutoff <- quantile(ufo_us$Duration, .99, na.rm = TRUE)[[1]]
# cutoff <- 20000

bg.color <- "#323232"
fg.color <- "#121212"
border.color <- "#222222"
text.color <- "light gray"

plot_usmap(fill = fg.color, color = border.color) +
  geom_point(
    data = ufo_us_coords %>% 
      filter(!is.na(Duration)) %>% 
      filter(Duration <= cutoff) %>% 
      filter(format(Date.Time, '%Y') == '2020') %>% 
      arrange(Duration), 
    aes(x = lng, y = lat, color = Duration), 
    alpha = 1
  ) +
  scale_color_viridis_c(
    option = 'viridis', 
    limits = c(0, cutoff),
    na.value = fg.color,
  ) +
  theme(
    plot.background = element_rect(fill = bg.color),
    legend.background = element_rect(fill = bg.color),
    legend.text = element_text(color = text.color),
    legend.title = element_text(color = text.color)
  )
```

```{r}
# cutoff <- mean(c(qt[[1]], qt[[2]]))
# cutoff <- 20000

year.range <- c(1969, 2021)

bg.color <- "#323232"
fg.color <- "#121212"
border.color <- "#222222"
text.color <- "light gray"

by.city <- ufo_us_coords %>% 
  filter(
    parse_integer(format(Date.Time, "%Y")) > year.range[1] &
    parse_integer(format(Date.Time, "%Y")) < year.range[2]
  ) %>% 
  mutate(year = parse_integer(format(Date.Time, "%Y"))) %>% 
  group_by(lat, lng) %>% 
  summarise(freq = n(), city = first(city_lower), .groups = "keep")

cutoff <- quantile(by.city$freq, .99)[[1]]

plot_usmap(fill = fg.color, color = border.color) +
  geom_point(
    data = by.city %>% arrange(freq) %>% filter(freq <= cutoff),
    aes(x = lng, y = lat, color = freq), 
    alpha = 1
  ) +
  geom_point(
    data = by.city %>% arrange(freq) %>% filter(freq > cutoff),
    aes(x = lng, y = lat),
    color = "white"
  ) +
  scale_color_viridis_c(
    option = 'plasma', 
    limits = c(0, cutoff),
    na.value = fg.color,
  ) +
  theme(
    plot.background = element_rect(fill = bg.color),
    legend.background = element_rect(fill = bg.color),
    legend.text = element_text(color = text.color),
    legend.title = element_text(color = text.color)
  )
```

This can also be replicated using a city map.


```{r}

year.range <- c(1969, 2021)

ufo_us %>% 
  filter(
    parse_integer(format(`Date/Time`, "%Y")) > year.range[1] &
    parse_integer(format(`Date/Time`, "%Y")) < year.range[2]
  ) %>% 
  mutate(year = parse_integer(format(`Date/Time`, "%Y"))) %>% 
  group_by(year) %>% 
  summarise(freq = n()) %>% 
  drop_na() %>% 
  ggplot() +
    geom_line(aes(x = year, y = freq))
  
```

A bar chart of ufo shapes

```{r}

```

A 

```{r}

```

